# Feature Plan 0002: Multi-Platform Authentication with Database Logging

## Brief Description
Add support for multiple authentication providers (Google, Apple, and other platforms) alongside the existing email/password and Google authentication. Implement database logging to track each signup and login event for analytics and user behavior monitoring.

## Current State Analysis
- **Existing Auth**: Firebase Authentication with email/password and Google OAuth
- **Current Providers**: GoogleAuthProvider already configured in `ui/src/lib/firebase.ts`
- **Database Integration**: Server middleware (`server/src/middleware/auth.ts`) already creates users on first login
- **User Schema**: Basic user table with id, email, display_name, photo_url, timestamps

## Database Schema Changes

### New Tables to Create

#### `auth_events` table in `server/src/schema/auth-events.ts`
```sql
CREATE TABLE app.auth_events (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES app.users(id),
  event_type TEXT NOT NULL, -- 'signup' | 'login' | 'logout'
  provider TEXT NOT NULL,   -- 'email' | 'google' | 'apple' | 'facebook' | etc.
  ip_address TEXT,
  user_agent TEXT,
  metadata JSONB,           -- Additional provider-specific data
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### Update `users` table in `server/src/schema/users.ts`
- Add `provider` field to track primary auth provider
- Add `provider_data` JSONB field for provider-specific metadata
- Add `last_login_at` timestamp field

## Frontend Changes

### Core Authentication Setup

#### `ui/src/lib/firebase.ts`
- Add Apple Auth Provider: `import { OAuthProvider } from 'firebase/auth'`
- Add Facebook Auth Provider: `import { FacebookAuthProvider } from 'firebase/auth'`
- Export new provider instances:
  - `export const appleProvider = new OAuthProvider('apple.com')`
  - `export const facebookProvider = new FacebookAuthProvider()`

#### `ui/src/lib/auth-context.tsx`
- Add auth event logging function that calls backend API
- Track authentication events (signup/login) with provider information
- Capture user agent and send to backend for logging

### UI Components

#### `ui/src/components/login-form.tsx`
- Add Apple Sign-In button with Apple branding
- Add Facebook Sign-In button with Facebook branding
- Add generic OAuth provider support for future providers
- Update error handling for new providers
- Add loading states for each provider button

#### `ui/src/components/landing/AuthSection.tsx`
- Mirror the same provider buttons as login-form
- Ensure consistent styling across login and signup forms
- Add provider icons and proper branding

#### New Component: `ui/src/components/auth-provider-button.tsx`
- Reusable component for authentication provider buttons
- Handles provider-specific styling, icons, and loading states
- Props: provider type, onClick handler, loading state, disabled state

### Icons and Assets
- Add Apple logo SVG component
- Add Facebook logo SVG component
- Ensure consistent sizing and styling with existing Google icon

## Backend Changes

### Database Layer

#### `server/src/schema/auth-events.ts` (New File)
- Define auth_events table schema using Drizzle ORM
- Export AuthEvent and NewAuthEvent types
- Include indexes for efficient querying by user_id and event_type

#### `server/src/schema/users.ts` (Update)
- Add new fields: `provider`, `provider_data`, `last_login_at`
- Update User and NewUser types

### API Layer

#### `server/src/middleware/auth.ts` (Update)
- Extract provider information from Firebase token
- Update user creation logic to include provider data
- Log authentication events to auth_events table
- Update last_login_at timestamp on each authenticated request

#### `server/src/api.ts` (Update)
- Add new endpoint: `POST /api/v1/auth/log-event`
- Endpoint accepts: event_type, provider, metadata
- Captures IP address and User-Agent from request headers
- Validates that user is authenticated before logging

### Authentication Event Logging

#### Event Types to Log
1. **Signup Events**: New user registration with any provider
2. **Login Events**: Existing user authentication with any provider
3. **Provider Linking**: When user links additional auth providers

#### Metadata to Capture
- Provider-specific user information
- Sign-in method details
- Device/browser information
- Timestamp and IP address

## Algorithm: Authentication Flow with Logging

### 1. User Initiates Authentication
- User clicks provider button (Google, Apple, Facebook, Email)
- Frontend shows loading state for selected provider

### 2. Firebase Authentication
- Frontend calls appropriate Firebase auth method
- Firebase handles OAuth flow for social providers
- Firebase returns user credentials and ID token

### 3. Backend User Creation/Update
- Frontend sends ID token to backend in Authorization header
- Backend middleware (`authMiddleware`) verifies token
- Extract provider information from Firebase token claims
- Upsert user record with provider data
- Update last_login_at timestamp

### 4. Authentication Event Logging
- Determine if this is signup (new user) or login (existing user)
- Extract provider name and metadata from Firebase token
- Call `/api/v1/auth/log-event` endpoint with event details
- Store auth event in database with IP, user agent, metadata

### 5. Frontend State Update
- Update auth context with authenticated user
- Redirect to appropriate authenticated page
- Handle any authentication errors gracefully

## Files to Create
- `server/src/schema/auth-events.ts`
- `ui/src/components/auth-provider-button.tsx`
- `server/drizzle/0001_auth_events.sql` (migration)

## Files to Modify
- `ui/src/lib/firebase.ts` - Add new auth providers
- `ui/src/lib/auth-context.tsx` - Add event logging
- `ui/src/components/login-form.tsx` - Add provider buttons
- `ui/src/components/landing/AuthSection.tsx` - Add provider buttons
- `server/src/schema/users.ts` - Add provider fields
- `server/src/middleware/auth.ts` - Add event logging
- `server/src/api.ts` - Add auth logging endpoint
- `server/drizzle.config.ts` - Ensure migration path

## Implementation Considerations

### Security
- Validate provider tokens server-side
- Rate limit authentication attempts
- Log failed authentication attempts for security monitoring
- Sanitize metadata before database storage

### Error Handling
- Handle provider-specific error codes
- Graceful fallback when providers are unavailable
- Clear error messages for users
- Proper logging of authentication failures

### Performance
- Batch authentication event logging where possible
- Index auth_events table for efficient analytics queries
- Consider async logging to avoid blocking authentication flow

### Configuration
- Firebase Console setup required for Apple Sign-In
- OAuth app registration needed for each provider
- Provider-specific configuration in Firebase project settings
