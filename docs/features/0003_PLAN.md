# Feature Plan 0003: Ride Matching & Payment System with Rewards

## Brief Description
Implement a comprehensive ride-matching system that automatically connects drivers and riders based on available vehicle space, route compatibility, and preferences. Include integrated payment processing for cost sharing, a rewards/points system to motivate users, and real-time communication features for ride coordination. This transforms the current social platform into a fully functional carpool marketplace.

## Current State Analysis
- **Existing Infrastructure**: Multi-provider authentication, user management, landing page, basic social framework
- **Database**: Users table with provider data, auth events logging
- **Tech Stack**: React/Vite frontend, Hono API backend, Supabase PostgreSQL, Firebase Auth
- **Missing**: Ride management, matching algorithm, payment integration, rewards system, real-time communication

## Phase 1: Data Layer & Core Schema

### New Database Tables

#### `vehicles` table in `server/src/schema/vehicles.ts`
```sql
CREATE TABLE app.vehicles (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES app.users(id),
  make TEXT NOT NULL,
  model TEXT NOT NULL,
  year INTEGER NOT NULL,
  color TEXT,
  license_plate TEXT,
  capacity INTEGER NOT NULL, -- total seats including driver
  fuel_type TEXT, -- 'gasoline' | 'diesel' | 'electric' | 'hybrid'
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### `rides` table in `server/src/schema/rides.ts`
```sql
CREATE TABLE app.rides (
  id SERIAL PRIMARY KEY,
  driver_id TEXT NOT NULL REFERENCES app.users(id),
  vehicle_id INTEGER NOT NULL REFERENCES app.vehicles(id),
  origin_address TEXT NOT NULL,
  origin_lat DECIMAL(10, 8) NOT NULL,
  origin_lng DECIMAL(11, 8) NOT NULL,
  destination_address TEXT NOT NULL,
  destination_lat DECIMAL(10, 8) NOT NULL,
  destination_lng DECIMAL(11, 8) NOT NULL,
  departure_time TIMESTAMP WITH TIME ZONE NOT NULL,
  arrival_time TIMESTAMP WITH TIME ZONE,
  available_seats INTEGER NOT NULL,
  price_per_seat DECIMAL(10, 2) NOT NULL,
  route_polyline TEXT, -- encoded polyline for route visualization
  distance_km DECIMAL(8, 2),
  duration_minutes INTEGER,
  status TEXT NOT NULL DEFAULT 'active', -- 'active' | 'full' | 'completed' | 'cancelled'
  recurring_pattern JSONB, -- for recurring rides: {days: ['monday', 'friday'], end_date: '2024-12-31'}
  preferences JSONB, -- driver preferences: {smoking: false, pets: false, music: true}
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### `ride_requests` table in `server/src/schema/ride-requests.ts`
```sql
CREATE TABLE app.ride_requests (
  id SERIAL PRIMARY KEY,
  ride_id INTEGER NOT NULL REFERENCES app.rides(id),
  rider_id TEXT NOT NULL REFERENCES app.users(id),
  seats_requested INTEGER DEFAULT 1,
  pickup_address TEXT NOT NULL,
  pickup_lat DECIMAL(10, 8) NOT NULL,
  pickup_lng DECIMAL(11, 8) NOT NULL,
  dropoff_address TEXT,
  dropoff_lat DECIMAL(10, 8),
  dropoff_lng DECIMAL(11, 8),
  status TEXT NOT NULL DEFAULT 'pending', -- 'pending' | 'accepted' | 'declined' | 'cancelled' | 'completed'
  message TEXT, -- rider's message to driver
  driver_response TEXT, -- driver's response message
  price_agreed DECIMAL(10, 2), -- final agreed price per seat
  requested_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  responded_at TIMESTAMP WITH TIME ZONE,
  UNIQUE(ride_id, rider_id)
);
```

#### `payments` table in `server/src/schema/payments.ts`
```sql
CREATE TABLE app.payments (
  id SERIAL PRIMARY KEY,
  ride_request_id INTEGER NOT NULL REFERENCES app.ride_requests(id),
  payer_id TEXT NOT NULL REFERENCES app.users(id),
  recipient_id TEXT NOT NULL REFERENCES app.users(id),
  amount DECIMAL(10, 2) NOT NULL,
  payment_method TEXT NOT NULL, -- 'card' | 'paypal' | 'venmo' | 'cash' | 'zelle'
  payment_provider TEXT, -- 'stripe' | 'paypal' | 'manual'
  provider_transaction_id TEXT,
  status TEXT NOT NULL DEFAULT 'pending', -- 'pending' | 'completed' | 'failed' | 'refunded'
  platform_fee DECIMAL(10, 2) DEFAULT 0,
  net_amount DECIMAL(10, 2) NOT NULL,
  processed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### `user_points` table in `server/src/schema/user-points.ts`
```sql
CREATE TABLE app.user_points (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES app.users(id),
  total_points INTEGER DEFAULT 0,
  lifetime_points INTEGER DEFAULT 0,
  tier TEXT DEFAULT 'bronze', -- 'bronze' | 'silver' | 'gold' | 'platinum'
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### `point_transactions` table in `server/src/schema/point-transactions.ts`
```sql
CREATE TABLE app.point_transactions (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES app.users(id),
  points_change INTEGER NOT NULL, -- positive for earned, negative for spent
  transaction_type TEXT NOT NULL, -- 'ride_completed' | 'driver_bonus' | 'referral' | 'reward_redeemed'
  reference_id INTEGER, -- ride_id, ride_request_id, or other reference
  description TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### `conversations` table in `server/src/schema/conversations.ts`
```sql
CREATE TABLE app.conversations (
  id SERIAL PRIMARY KEY,
  ride_request_id INTEGER NOT NULL REFERENCES app.ride_requests(id),
  participants TEXT[] NOT NULL, -- array of user_ids [driver_id, rider_id]
  last_message_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### `messages` table in `server/src/schema/messages.ts`
```sql
CREATE TABLE app.messages (
  id SERIAL PRIMARY KEY,
  conversation_id INTEGER NOT NULL REFERENCES app.conversations(id),
  sender_id TEXT NOT NULL REFERENCES app.users(id),
  message_text TEXT NOT NULL,
  message_type TEXT DEFAULT 'text', -- 'text' | 'location' | 'system'
  read_by TEXT[] DEFAULT '{}', -- array of user_ids who have read the message
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

## Phase 2A: Backend API Development

### New API Endpoints

#### Vehicle Management - `server/src/api/vehicles.ts`
- `POST /api/v1/vehicles` - Create vehicle
- `GET /api/v1/vehicles` - Get user's vehicles
- `PUT /api/v1/vehicles/:id` - Update vehicle
- `DELETE /api/v1/vehicles/:id` - Delete vehicle

#### Ride Management - `server/src/api/rides.ts`
- `POST /api/v1/rides` - Create ride offer
- `GET /api/v1/rides` - Get user's rides (as driver)
- `GET /api/v1/rides/search` - Search available rides with filters
- `PUT /api/v1/rides/:id` - Update ride details
- `DELETE /api/v1/rides/:id` - Cancel ride

#### Ride Requests - `server/src/api/ride-requests.ts`
- `POST /api/v1/rides/:rideId/requests` - Request to join ride
- `GET /api/v1/ride-requests` - Get user's ride requests
- `PUT /api/v1/ride-requests/:id/accept` - Driver accepts request
- `PUT /api/v1/ride-requests/:id/decline` - Driver declines request
- `DELETE /api/v1/ride-requests/:id` - Cancel request

#### Matching Algorithm - `server/src/api/matching.ts`
- `GET /api/v1/rides/matches` - Get compatible rides for rider's route
- `POST /api/v1/rides/auto-match` - Auto-match riders to available rides

#### Payment Processing - `server/src/api/payments.ts`
- `POST /api/v1/payments/process` - Process payment for ride
- `GET /api/v1/payments` - Get user's payment history
- `POST /api/v1/payments/refund` - Process refund

#### Points & Rewards - `server/src/api/points.ts`
- `GET /api/v1/points` - Get user's points balance and tier
- `GET /api/v1/points/history` - Get points transaction history
- `POST /api/v1/points/redeem` - Redeem points for rewards

#### Messaging - `server/src/api/messages.ts`
- `GET /api/v1/conversations` - Get user's conversations
- `GET /api/v1/conversations/:id/messages` - Get messages in conversation
- `POST /api/v1/conversations/:id/messages` - Send message
- `PUT /api/v1/messages/:id/read` - Mark message as read

### Matching Algorithm Implementation

#### Core Matching Logic in `server/src/lib/matching-algorithm.ts`
1. **Geographic Proximity**: Match based on pickup/dropoff locations within configurable radius
2. **Route Compatibility**: Calculate route deviation to accommodate rider's pickup/dropoff
3. **Time Compatibility**: Match departure times within acceptable window (Â±30 minutes)
4. **Preference Matching**: Consider driver/rider preferences (smoking, pets, music, etc.)
5. **Capacity Checking**: Ensure available seats match rider's requirements
6. **User Ratings**: Prioritize matches with higher-rated users

#### Matching Score Calculation
```javascript
matchScore = (
  geographicScore * 0.4 +
  timeScore * 0.3 +
  preferenceScore * 0.2 +
  ratingScore * 0.1
)
```

## Phase 2B: Frontend UI Development

### New Pages

#### `ui/src/pages/rides/` Directory
- **`CreateRide.tsx`** - Form to create new ride offer
- **`MyRides.tsx`** - Dashboard for driver's rides and requests
- **`SearchRides.tsx`** - Search and filter available rides
- **`RideDetails.tsx`** - Detailed view of specific ride
- **`RideRequests.tsx`** - Manage incoming ride requests (driver view)
- **`MyBookings.tsx`** - Rider's booked rides and requests

#### `ui/src/pages/vehicles/` Directory
- **`VehicleList.tsx`** - List user's vehicles
- **`AddVehicle.tsx`** - Add new vehicle form
- **`EditVehicle.tsx`** - Edit vehicle details

#### `ui/src/pages/payments/` Directory
- **`PaymentHistory.tsx`** - View payment transactions
- **`PaymentMethods.tsx`** - Manage payment methods
- **`ProcessPayment.tsx`** - Payment flow for ride

#### `ui/src/pages/rewards/` Directory
- **`PointsBalance.tsx`** - View points and tier status
- **`RewardsStore.tsx`** - Redeem points for rewards
- **`PointsHistory.tsx`** - Points transaction history

#### `ui/src/pages/messages/` Directory
- **`ConversationList.tsx`** - List of conversations
- **`ChatWindow.tsx`** - Real-time messaging interface

### Key Components

#### `ui/src/components/rides/`
- **`RideCard.tsx`** - Display ride information in card format
- **`RideSearchFilters.tsx`** - Advanced search filters
- **`RouteMap.tsx`** - Interactive map showing ride route
- **`RequestRideModal.tsx`** - Modal for requesting to join ride
- **`RideStatusBadge.tsx`** - Status indicator for rides

#### `ui/src/components/matching/`
- **`MatchedRidesList.tsx`** - Display compatible rides
- **`MatchScore.tsx`** - Visual match compatibility score
- **`AutoMatchToggle.tsx`** - Enable/disable auto-matching

#### `ui/src/components/payments/`
- **`PaymentMethodSelector.tsx`** - Choose payment method
- **`PaymentSummary.tsx`** - Payment breakdown display
- **`StripePaymentForm.tsx`** - Stripe integration component

#### `ui/src/components/rewards/`
- **`PointsDisplay.tsx`** - Show current points and tier
- **`TierProgressBar.tsx`** - Visual tier progress
- **`RewardCard.tsx`** - Individual reward item

### Navigation Updates

#### `ui/src/components/appSidebar.tsx` - Add new menu items:
- Rides (with submenu: Search, My Rides, Create Ride)
- Vehicles
- Messages
- Rewards
- Payment History

## Phase 3: External Integrations

### Google Maps Integration
- **Route calculation and optimization**
- **Real-time traffic data**
- **Geocoding for address validation**
- **Interactive map components**

### Payment Processing Integration
- **Stripe**: Primary payment processor for cards
- **PayPal**: Alternative payment method
- **Venmo/Zelle**: Peer-to-peer payment options
- **Cash handling**: Manual confirmation system

### Real-time Features
- **WebSocket implementation** for live messaging
- **Push notifications** for ride updates
- **Location tracking** during active rides

## Unique Features Beyond Standard Carpool Apps

### 1. Social Credit System
- **Trust Score**: Based on completed rides, ratings, and social connections
- **Community Endorsements**: Users can vouch for each other
- **Local Reputation**: Higher visibility for users in same neighborhoods/workplaces

### 2. Professional Network Integration
- **LinkedIn-style connections** for work commutes
- **Company partnerships** for employee carpooling programs
- **Professional event ride coordination**
- **Business travel cost sharing**

### 3. Sustainability Tracking
- **Carbon footprint reduction metrics**
- **Environmental impact leaderboards**
- **Green rewards** for consistent carpooling
- **Partnership with environmental organizations**

### 4. Smart Matching Features
- **AI-powered personality matching** based on preferences
- **Commute pattern learning** for automatic suggestions
- **Weather-based matching** (covered cars during rain)
- **Event-based rides** (concerts, sports games, conferences)

### 5. Community Features
- **Neighborhood carpooling groups**
- **Regular commute buddy matching**
- **Carpool challenges and competitions**
- **Local business partnerships** (discounts for carpoolers)

### 6. Safety & Security
- **Real-time ride tracking** shared with emergency contacts
- **In-app emergency button**
- **Driver verification** with background checks
- **Insurance integration** for ride coverage

## Implementation Phases

### Phase 1: Data Foundation (Week 1-2)
- Create all database schemas and migrations
- Set up basic CRUD operations for core entities
- Implement user points system foundation

### Phase 2A: Core Backend (Week 3-4)
- Develop ride management APIs
- Implement matching algorithm
- Create messaging system backend
- Set up payment processing infrastructure

### Phase 2B: Core Frontend (Week 3-4) - Parallel to 2A
- Build ride creation and search interfaces
- Implement vehicle management UI
- Create messaging components
- Develop payment flow UI

### Phase 3: Advanced Features (Week 5-6)
- Integrate Google Maps and real-time features
- Implement rewards system and gamification
- Add social features and community tools
- Deploy and test payment processing

### Phase 4: Polish & Launch (Week 7-8)
- Performance optimization
- Security auditing
- Mobile responsiveness
- User testing and feedback integration

## Files to Create

### Database Schemas
- `server/src/schema/vehicles.ts`
- `server/src/schema/rides.ts`
- `server/src/schema/ride-requests.ts`
- `server/src/schema/payments.ts`
- `server/src/schema/user-points.ts`
- `server/src/schema/point-transactions.ts`
- `server/src/schema/conversations.ts`
- `server/src/schema/messages.ts`

### Backend APIs
- `server/src/api/vehicles.ts`
- `server/src/api/rides.ts`
- `server/src/api/ride-requests.ts`
- `server/src/api/matching.ts`
- `server/src/api/payments.ts`
- `server/src/api/points.ts`
- `server/src/api/messages.ts`

### Core Libraries
- `server/src/lib/matching-algorithm.ts`
- `server/src/lib/payment-processor.ts`
- `server/src/lib/points-calculator.ts`
- `server/src/lib/notifications.ts`

### Frontend Pages (20+ new pages)
- All pages listed in Phase 2B section above

### Frontend Components (30+ new components)
- All components listed in Phase 2B section above

### Database Migrations
- `server/drizzle/0002_rides_system.sql`
- `server/drizzle/0003_payments_rewards.sql`
- `server/drizzle/0004_messaging_system.sql`

## Files to Modify

### Backend Updates
- `server/src/api.ts` - Mount new route handlers
- `server/src/schema/users.ts` - Add ride-related user fields
- `server/src/middleware/auth.ts` - Add role-based permissions

### Frontend Updates
- `ui/src/App.tsx` - Add new routes for ride management
- `ui/src/components/appSidebar.tsx` - Add navigation items
- `ui/src/components/navbar.tsx` - Add ride-related quick actions

### Configuration
- `ui/package.json` - Add new dependencies (Google Maps, Stripe, etc.)
- `server/package.json` - Add payment processing libraries

## Environment Variables Required
```
# Google Maps
GOOGLE_MAPS_API_KEY=

# Payment Processing  
STRIPE_SECRET_KEY=
STRIPE_PUBLISHABLE_KEY=
PAYPAL_CLIENT_ID=
PAYPAL_CLIENT_SECRET=

# WebSocket/Real-time
WEBSOCKET_PORT=
```

This comprehensive plan transforms the current authentication-focused social platform into a full-featured carpool marketplace with unique social and professional networking aspects that differentiate it from standard ride-sharing apps.
